name: Pre-Release Draft SDK Core-Subgraph Integration Test

on:
  pull_request:
    branches:
      - "release-subgraph-v1"
      - "release-sdk-core-stable"
    paths:
      - "packages/subgraph/**"
      - "packages/sdk-core/**"
      - ".github/workflows/ci.pre-release-draft-test-sdk-core-subgraph-integration.yml"

jobs:
  show-contexts:
    name: Show Contexts

    runs-on: ubuntu-latest

    steps:
      - name: Show contexts
        run: |
          echo github.event_name: ${{ github.event_name }}
          echo github.sha: ${{ github.sha }}
          echo github.repository: ${{ github.repository }}
          echo github.ref: ${{ github.ref }}
          echo github.head_ref: ${{ github.head_ref }}
          echo github.base_ref: ${{ github.base_ref }}

  build-and-test-local-subgraph:
    name: Build and test locally deployed subgraph

    runs-on: ubuntu-latest

    env:
      contracts-working-directory: ./packages/ethereum-contracts

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x
          
      - name: "Install packages and start hardhat node"
        run: |
          yarn install
          ./tasks/startHardhatNode start
        working-directory: ./packages/sdk-core

      - name: "Checkout graph node repo and set up local graph node"
        uses: actions/checkout@v3
        with:
          repository: graphprotocol/graph-node
          path: graph-node
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Run setup because linux and docker-compose"
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          chmod +x setup.sh
          ./setup.sh
        working-directory: ./graph-node/docker

      - name: "Docker compose"
        run: docker-compose up &
        working-directory: ./graph-node/docker

      - name: "Install contract dependencies"
        run: yarn install
        working-directory: ${{ env.contracts-working-directory }}

      - name: "Build contracts"
        run: yarn run build:contracts
        working-directory: ${{ env.contracts-working-directory }}

        # test local subgraph
      - name: "Run SDK-Core tests and test subgraph query with local subgraph"
        run: |
          yarn generate-graphql-schema:v1
          ./tasks/setupTestEnvironment.sh
          npx hardhat test
        working-directory: ./packages/sdk-core
        env: 
          LOCAL_SUBGRAPH_URL: http://localhost:8000/subgraphs/name/superfluid-test

  # build and test live subgraph with release sdk-core
  build-and-test-live-subgraph-current-release:
    name: Build and test live subgraph with current release

    runs-on: ubuntu-latest

    env:
      env.contracts-working-directory: ./packages/ethereum-contracts
    
    steps:
      - uses: actions/checkout@v3
    
      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x
          
      - name: "Install contract dependencies"
        run: yarn install
        working-directory: ${{ env.contracts-working-directory }}

      - name: "Build contracts"
        run: yarn run build:contracts
        working-directory: ${{ env.contracts-working-directory }}

      - name: "Install packages and test"
        run: |
          yarn install
          yarn generate-graphql-schema:feature
          yarn test
        working-directory: ./packages/sdk-core
        env:
          SUBRGAPH_RELEASE_TAG: v1

  # build and test live subgraph with previous sdk-core releases
  build-and-test-live-subgraph-previous-releases:
    name: Build and test live subgraph with current release

    runs-on: ubuntu-latest

    matrix:
      version: [0.3.2, 0.4.0, 0.4.1]

    env:
      env.contracts-working-directory: ./packages/ethereum-contracts
    
    steps:
      - uses: actions/checkout@v3
    
      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x
          
      - name: "Install contract dependencies"
        run: yarn install
        working-directory: ${{ env.contracts-working-directory }}

      - name: "Build contracts"
        run: yarn run build:contracts
        working-directory: ${{ env.contracts-working-directory }}

      - name: "Install packages and test"
        run: |
          yarn install
          ./tasks/startHardhatNode.sh start
          ./tasks/setupTestEnvironment.sh
        working-directory: ./packages/sdk-core

      - name: "Install @superfluid-finance/sdk-core@${{ matrix.version}} and test subgraph query"
        run: |
          yarn add -D @superfluid-finance/sdk-core@v${{ matrix.version }}
          yarn run-query-tests
          ./tasks/startHardhatNode.sh stop

        working-directory: ./packages/sdk-core/previous-versions-testing